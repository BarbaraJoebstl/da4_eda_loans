---
title: "R Notebook"
output: html_notebook
---
```{r}
install.packages('ggplot2')
```
#The data

This data set contains 113,937 loans with 81 variables on each loan, including loan amount, borrower rate (or interest rate), current loan status, borrower income, borrower employment status, borrower credit history, and the latest payment information.

//TODO Explorte 10 - 15 Variables

```{r}
library(ggplot2)

loanData <- read.csv('prosperLoanData.csv')
head(loanData)

```
# First Look
In this data set there are 81 Variables. To Start the most interresting for me seem to be
# https://www.prosper.com/Downloads/Services/Documentation/ProsperDataExport_Details.html


What?
* LoanOriginalAmount
* Term: The length of the loan expressed in months.
* Loan Origin Date

Who?
* isBorrowerHomeOwner
* Occupation
* CreditGrade
* CurrentDelinquencies

Why?
* ListingCategory: numeric 
** The category of the listing that the borrower selected when posting their listing: 0 - Not Available, 1 - Debt Consolidation, 2 - Home Improvement, 3 - Business, 4 - Personal Loan, 5 - Student Use, 6 - Auto, 7- Other, 8 - Baby&Adoption, 9 - Boat, 10 - Cosmetic Procedure, 11 - Engagement Ring, 12 - Green Loans, 13 - Household Expenses, 14 - Large Purchases, 15 - Medical/Dental, 16 - Motorcycle, 17 - RV, 18 - Taxes, 19 - Vacation, 20 - Wedding Loans

* BankcardUtilization
* IncomeRange
* EmploymentStatus

Help from Friends?
* InvestementFromFriendsAmount
* Investors

Is your credit rate ok?
*BorrowerAPR: The Borrower's Annual Percentage Rate (APR) for the loan.
*BorrowerRate: The Borrower's interest rate for this loan. The is the rate the borrower pays if the loan were to close at this point in time. The rate is computed as the LenderRate + GroupLeaderRewardRate (if applicable) + BankDraftFeeAnnualRate (if applicable).

*ProsperScore: A custom risk score built using historical Prosper data. The score ranges from 1-10, with 10 being the best, or lowest risk score. Applicable for loans originated after July 2009.


LoanOriginalAmount and Terms by Year
- extract the year of the LoanOriginData and save it to a new variable 


#How much money is needed?
```{r}

ggplot(aes(x = LoanOriginalAmount), data = loanData) + 
  geom_histogram( fill = ('#F79420')) 

```
```{r}
summary(loanData$LoanOriginalAmount)
```
#create a new DF with info about the prosper rating and the amount
```{r}
library(dplyr)
creditsByGrade <- group_by(loanData, ProsperRating..numeric.)
creditsByGrade <- summarise(creditsByGrade,
    mean_amount = mean(LoanOriginalAmount), 
    median_amount = median(LoanOriginalAmount),
    min_amount = min(LoanOriginalAmount),
    max_amount = max(LoanOriginalAmount),
    n = n()) 

creditsByGrade

```

Most of loans are under 5000,--. I suggest the money is needed for sonderausgaben, die im Haushaltsbudget keinen Platz mehr gefunden haben. Möglicherweise Schäden im Haushalt oder Sonderausgaben aufgrund von unvorhersehbaren Umständen. Unfälle...

Sehen wir uns nun an, für was das Geld benötigt wurde. -> unsere Annahme bestägigen
```{r loans by category }
# transform the numeric value of categories to readable names:

loanData$Category[loanData$ListingCategory..numeric. == '0'] <- 'Not Available'
loanData$Category[loanData$ListingCategory..numeric. == '1'] <- 'Debt Consolidation'
loanData$Category[loanData$ListingCategory..numeric. == '2'] <- 'Home Improvement'
loanData$Category[loanData$ListingCategory..numeric. == '3'] <- 'Business'
loanData$Category[loanData$ListingCategory..numeric. == '4'] <- 'Personal Loan'
loanData$Category[loanData$ListingCategory..numeric. == '5'] <- 'Student Use'
loanData$Category[loanData$ListingCategory..numeric. == '6'] <- 'Auto'
loanData$Category[loanData$ListingCategory..numeric. == '7'] <- 'Other'
loanData$Category[loanData$ListingCategory..numeric. == '8'] <- 'Baby & Adoption'
loanData$Category[loanData$ListingCategory..numeric. == '9'] <- 'Boat'
loanData$Category[loanData$ListingCategory..numeric. == '10'] <- 'Cosmetic Procedure'
loanData$Category[loanData$ListingCategory..numeric. == '11'] <- 'Engagement Ring'
loanData$Category[loanData$ListingCategory..numeric. == '12'] <- 'Green Loans'
loanData$Category[loanData$ListingCategory..numeric. == '13'] <- 'Household Expenses'
loanData$Category[loanData$ListingCategory..numeric. == '14'] <- 'Large Purchases'
loanData$Category[loanData$ListingCategory..numeric. == '15'] <- 'Medical/Dental'
loanData$Category[loanData$ListingCategory..numeric. == '16'] <- 'Motorcycle'
loanData$Category[loanData$ListingCategory..numeric. == '17'] <- 'RV'
loanData$Category[loanData$ListingCategory..numeric. == '18'] <- 'Taxes'
loanData$Category[loanData$ListingCategory..numeric. == '19'] <- 'Vacation'
loanData$Category[loanData$ListingCategory..numeric. == '20'] <- 'Wedding Loans'

```

#WHy?
```{r}
reorder_size <- function(x) {
  factor(x, levels = names(sort(table(x))))
}

ggplot(data= subset(loanData,
                    LoanOriginalAmount > 2500 & LoanOriginalAmount <= 9000 & Category != 'Debt Consolidation' & Category != 'Not Available' & Category != 'Other'), aes(reorder_size(Category))) +
    geom_bar(colour = "green")+
    ggtitle("Amount of loans by category") +
  theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5))+
    labs(x="", y = "Number of loans") +
  coord_flip()

```



As the most categories are debt consolidation, not availabe and other we cant really tell if it is like suggested. The data is not complete. But mostly money is needed for household expenses or home improvement. 
WHO?

```{r}
summary(loanData$Occupation)
```
To make this easier to read, we want to combine groups into a new data frame. Students, Tradesman, Health
```{r}

loanData$GroupedOccupation <- factor(loanData$Occupation)
levels(loanData$GroupedOccupation) <- list(
  Student=c("Student - College Graduate Student",
"Student - College Senior", 
"Student - Community College",
"Student - College Freshman",
"Student - College Junior",
"Student - College Sophomore",
"Student - Technical School"), 
Medical_Health=c("Doctor", "Nurse's Aide",
                 "Nurse (RN)",
                 "Nurse (LPN)",
                 "Dentist",
                 "Pharmacist",
                 "Medical Technician",
                 "Psychologist"),
Sales=c("Sales - Commission",
        "Sales - Retail",
        "Car Dealer",
        "Realtor"),
Service=c("Food Service Management",
          "Food Service",
          "Postal Service",
          "Social Worker",
          "Truck Driver",
          "Bus Driver",
          "Retail Management",
          "Waiter/Waitress",
          "Flight Attendant",
          "Clerical",
          "Religious",
          "Clergy"),
Laborer=c("Construction",
          "Laborer",
          "Skilled Labor",
          "Landscaping",
          "Homemaker",
          "Fireman",
          "Executive",
          "Teacher's Aide",
          "Computer Programmer",
          "Administrative Assistant",
          "Professional",
          "Accountant/CPA",
          "Tradesman - Carpenter",
            "Tradesman - Mechanic",
            "Tradesman - Electrician",
            "Tradesman - Plumber",
          "Pilot - Private/Commercial"),
HigherEdJobs=c("Architect",
               "Biologist",
               "Engineer - Electrical",
               "Engineer - Mechanical",
               "Engineer - Chemical",
               "Judge", "Teacher",
               "Scientist",
               "Professor",
               "Attorney", "Analyst", "Accountant/CPA"
               ),
CivilService=c("Civil Service",
               "Military Officer",
               "Police Officer/Correction Officer",
               "Military Enlisted"),
Other=c("Other", "")
)


ggplot(data=subset(loanData, GroupedOccupation != 'Other' & !is.na(GroupedOccupation)), x=GroupedOccupation, aes(reorder_size(GroupedOccupation))) +
    geom_bar()+
    ggtitle("Borrowers by Occupation")+
    labs(x="", y = "Number of loans")+
        theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5))

```

In the next step I want to proof the people who aren t house owners need more often small loans for Vacation, HomeImprovement or Household Expenses.

```{r}
summary(loanData$IsBorrowerHomeowner)
```

house owner need less credits
NEXt: limit to smaller amount of loan and check if loan taker is a house owner






```{r}
  qplot(x=IsBorrowerHomeowner, y=LoanOriginalAmount,
        data=loanData, geom = 'boxplot') +
  scale_y_continuous(limits = c(1000, 20000))
```


#relation between prosper rate and houseOwner
```{r}

qplot(x=IsBorrowerHomeowner, y=ProsperScore,
        data=loanData, geom = 'boxplot') +
  scale_y_continuous()
```


```{r}
ggplot(aes(x = IsBorrowerHomeowner, y = LoanOriginalAmount),
      data = loanData) +
      stat_summary(fun.y = mean, geom= 'point', shape = 4)

ggplot(aes(x=GroupedOccupation, y=LoanOriginalAmount),
      data = loanData) +
      theme(axis.text.x=element_text(angle=45,hjust=1,vjust=0.5))+
      geom_point(aes(color= IsBorrowerHomeowner, alpha=1/20))
```

```{r}
ggplot(aes(x=GroupedOccupation, y=LoanOriginalAmount),
      data = loanData) +
      theme(axis.text.x=element_text(angle=45,hjust=0.5,vjust=0.5))+
      geom_point(aes(color= IsBorrowerHomeowner))+
scale_y_continuous(limits=c(0, 5000))
```
#for money less than 5000 the majority of the borrowers aren t houseowners. Maybe the grouping is not correct. ie in group mediacl nd help there are doctors, nurses et...


#check if homeowner have a better Prosperscore
#Prosper A custom risk score built using historical Prosper data. The score ranges from 1-10, with 10 being the best, or lowest risk score.

#BorrowerRate: The is the rate the borrower pays if the loan were to close at this point in time. The rate is computed as the LenderRate + GroupLeaderRewardRate (if applicable) + BankDraftFeeAnnualRate (if applicable).

Borrower Rate: The is the rate the borrower pays if the loan were to close at this point in time. The rate is computed as the LenderRate + GroupLeaderRewardRate (if applicable) + BankDraftFeeAnnualRate (if applicable).

ProsperScore: A custom risk score built using historical Prosper data. The score ranges from 1-10, with 10 being the best, or lowest risk score.

Total Credit Lines past 7 years:

```{r}
summary(loanData$MonthlyLoanPayment)
#prosper score -> house owners have a better one
ggplot(aes(x=CurrentDelinquencies, y=..count../sum(..count..)), data = subset(loanData, !is.na(IsBorrowerHomeowner))) +
  geom_freqpoly(aes(color = IsBorrowerHomeowner)) + 
  xlab('Prosper Rating') + 
  ylab('Percentage of Borrowers with that Prosper Rating')
```


```{r}
ggplot(aes(x=BorrowerRate, y=ProsperScore), data = loanData)+
  geom_line()+
  geom_smooth()
```
no surprises here, the better the Prosper Score, the better the Borrower Rate ->
Hockey Stick ??


#byIncomeRAnge..




When was the money needed?

```{r Loans over time}
loanData$LoanOriginationYear <- format(as.Date(loanData$LoanOriginationDate, format="%Y-%m-%d"),"%Y")

ggplot(aes(x = LoanOriginationYear, y = LoanOriginalAmount, fill=Term, group=LoanOriginationYear), data =loanData) +
    geom_bar(aes(group = LoanOriginationYear), position='dodge', stat='identity')+
    ggtitle("Loans by Year") +
    labs(x="Loan origination year", y = "Loan original amount")
```
IncomeRange:

Income: The income range of the borrower at the time the lisitng was created is one of the following values:
0 - Not displayed
1 - $0 or unable to verify
2 - $1-24,999
3 - $25,000-49,999
4 - $50,000-74,999
5 - $75,000-99,999
6 - $100,000+
7 - Not Employed

Income verifyalble:

CurrentDelinquenies: Number of current delinquencies at the time the listing was created.


Is there a connection between income of borrowers and 

```{r}
ggplot(aes(x=ProsperRating..numeric., y=..count../sum(..count..)), data = subset(loanData, !is.na(IncomeVerifiable))) +
  geom_freqpoly(aes(color = IncomeVerifiable)) + 
  xlab('Prosper Rating') + 
  ylab('Percentage of Borrowers with that Prosper Rating')

```

EmploymentStatus: Employment Status Duration In Months.


```{r}

summary(loanData$EmploymentStatusDuration)
loanData$bucket_EmploymentStatusDuration <- cut(loanData$EmploymentStatusDuration,
                               c(0, 12, 24, 36, 48, 50, 62, 74, 86, 98, 110, 122, 134, 146, 755))


ggplot(aes(x = CreditGrade, y=EmploymentStatusDuration),
       data = loanData) +
  geom_point(aes(color = 
                  EmploymentStatus))

```



```{r}
library(dplyr)

ggplot(aes(x=CreditGrade, y=EmploymentStatusDuration), data = loanData) + 
  geom_point(aes(color=EmploymentStatus))

#ggplot(aes(x=LoanOriginationDate, y=LoanOriginalAmount), data = loanData) + 
#  geom_point(aes(color=IncomeRange))

#  detach("package:plyr", unload=TRUE)

```

```{r}
ggplot(aes(x=CreditGrade, y=bucket_EmploymentStatusDuration), data = loanData) + 
  geom_point(aes(color=EmploymentStatus))

```

```{r}
ggplot(aes(x=Term, y=LoanOriginalAmount), data = loanData) +
    facet_wrap(~GroupedOccupation) +
    geom_point(aes(color = Category)) +
  scale_y_continuous(limits=c(1000, 5000))
```
```{r}
loanData$loan_income_ratio = loanData$LoanOriginalAmount/loanData$StatedMonthlyIncome
ggplot(data = loanData, aes(x = loan_income_ratio)) +                
        geom_histogram(color = "black", fill = '#007EE5', binwidth = 0.02) +
        xlim(0, quantile(loanData$loan_income_ratio, prob = 0.57, na.rm=TRUE)) +
        ggtitle("Debt To Income Ratio") +
        xlab("Debt to Income Ratio") +
        ylab("Count")
summary(loanData$loan_income_ratio)

```


LoanOriginalAmount: Amount needed

Borrower Rate: The borrower rate for this loan.

Lender Yield: The interest rate the lender receives on the loan.


```{r}
library(dplyr)
ggplot(loanData, aes(x = LenderYield, y = BorrowerRate)) +
  geom_point(alpha=1/20) +
  scale_x_continuous(limits=c(0, quantile(loanData$LenderYield, 0.99))) +
  scale_y_continuous( 
                     limits=c(0 , quantile(loanData$BorrowerRate, 0.99)))

```


```{r}
ggplot(loanData, aes(x = BorrowerRate, y = LenderYield,
                     color = IsBorrowerHomeowner, size=count)) +
  geom_point() +
  geom_smooth() +
  geom_point(data = subset(loanData, Category %in% c(
    
'Debt Consolidation', 'Home Improvement'
,'Business'
,'Personal Loan'
,'Student Use'
,'Auto'
,'Other'
,'Baby & Adoption'
,'Boat'
,'Cosmetic Procedure'
,'Engagement Ring'
,'Green Loans'
,'Household Expenses'
,'Large Purchases'
,'Medical/Dental'
,'Motorcycle'
,'RV'
,'Taxes'
,'Vacation'
,'Wedding Loans'
  )), 
             aes(label = Loans),
             color="#0266c8") +
  geom_text(data = subset(loanData, Category %in% c(
    
    'Debt Consolidation', 'Home Improvement'
,'Business'
,'Personal Loan'
,'Student Use'
,'Auto'
,'Other'
,'Baby & Adoption'
,'Boat'
,'Cosmetic Procedure'
,'Engagement Ring'
,'Green Loans'
,'Household Expenses'
,'Large Purchases'
,'Medical/Dental'
,'Motorcycle'
,'RV'
,'Taxes'
,'Vacation'
,'Wedding Loans')),
            aes(label = Loans),
            color = "black",
            size = 3,
            vjust = -0.5) +
  #geom_abline(intercept = 0, slope = 1, linetype=2, color="orange") +
  ylab("Average Science Score") + 
  xlab("Average Reading Score") + 
  ggtitle("Average Reading and Science Scores per country, by gender")

```

# what happenend in 2011?


nExt: 


#Problems
-Convert Origin Date to only the year..
-Map Readable values to Category numeric..
- Job duration in months


